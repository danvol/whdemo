<?xml version="1.0" encoding="UTF-8"?>

<config>
	<var-def name="cat0">
		<html-to-xml>
			<http method="post" url="http://directory.rakuten.co.jp/">
		    </http>
		</html-to-xml>
	</var-def>
	<csv dir="output/rakuten/" writeheader="true" delimiter="," charset="UTF-8" filename="rakuten.csv">
		<loop item="catUrl" index="i">
			<list>
				<xpath expression="//a/@href[contains(., 'search.rakuten.co.jp/search/mall')]">
					<var name="cat0"></var>
				</xpath>
			</list>
			<body>
				<empty>
					<var-def name="cat1">
						<html-to-xml>
							<http method="post" url="${catUrl}">
						    </http>
						</html-to-xml>
					</var-def>
					<var-def name="cat1-href">
						<xpath expression="//div[@class='txtInbox']/ul[@class='rsrAsideArrowLi rsrGenreNavigation']/li/a/@href">
							<var name="cat1"></var>
						</xpath>
					</var-def>
					<var-def name="cat1-name">
						<xpath expression="//div[@class='txtInbox']/ul[@class='rsrAsideArrowLi rsrGenreNavigation']/li/a/text()">
							<var name="cat1"></var>
						</xpath>
					</var-def>
					<var-def name="cat1-value">
						<xpath expression="//div[@class='txtInbox']/ul[@class='rsrAsideArrowLi rsrGenreNavigation']/li/a/@data-genreid">
							<var name="cat1"></var>
						</xpath>
					</var-def>
				</empty>
				<loop item="catUrlSub1" index="j">
					<list>
						<xpath expression="//div[@class='txtInbox']/ul[@class='rsrAsideArrowLi rsrGenreNavigation']/li[@class='down']/ul/li/a/@href">
							<var name="cat1"></var>
						</xpath>
					</list>
					<body>
						<empty>
							<var-def name="page">
								<html-to-xml>
									<http method="post" url="${catUrlSub1}">
								    </http>
								</html-to-xml>
							</var-def>
						</empty>
					    <template>
					        <![CDATA[]]>
					                <xquery>
					                    <xq-param name="page" type="node()"><var name="page"/></xq-param>
					                    <xq-param name="tCalHref" type="string"><var name="cat1-href"/></xq-param>
					                    <xq-param name="tCalName" type="string"><var name="cat1-name"/></xq-param>
					                    <xq-param name="tCalValue" type="string"><var name="cat1-value"/></xq-param>
					                    <xq-expression><![CDATA[
					                            declare variable $page as node() external;
					                            declare variable $tCalHref as xs:string external;
					                            declare variable $tCalName as xs:string external;
					                            declare variable $tCalValue as xs:string external;
					                            
					 				            let $m := $page//div[@class='txtInbox']/ul[@class='rsrAsideArrowLi rsrGenreNavigation']/li/a
					                            let $mh := data($m/@href)
					                            let $mn := data($m)
					                            let $mv := data($m//@data-genreid)
					                            
					                            let $m1 := $page//link[@rel='canonical']
					                            let $m1h := data($m1/@href)
					                            let $m1n := data($page//div[@id='topicPathBox']/h1)
					                            let $m1v := data(($page//input[@type='hidden' and @name='g'])[1]/@value)
					                            
					                            let $a := $page//div[@class='txtInbox']/ul[@class='rsrAsideArrowLi rsrGenreNavigation']/li[@class='down']/ul/li
												for $aa in $a
					                            let $href := data($aa//@href)
					                            let $name := data($aa)
					                            let $value := data($aa//@data-genreid)
				                                return 
				                                    <result>
							                            <name>{$name}</name>
														<value>{$value}</value>
														<href>{$href}</href>
														<mid1CalName>{$m1n}</mid1CalName>
														<mid1CalValue>{$m1v}</mid1CalValue>
														<mid1CalHref>{$m1h}</mid1CalHref>
														<mid0CalName>{$mn}</mid0CalName>
														<mid0CalValue>{$mv}</mid0CalValue>
														<mid0CalHref>{$mh}</mid0CalHref>
														<topCalName>{$tCalName}</topCalName>
														<topCalValue>{$tCalValue}</topCalValue>
														<topCalHref>{$tCalHref}</topCalHref>
				                                    </result>
				                                    
					                    ]]></xq-expression>
					                </xquery>
					        <![CDATA[]]>
					    </template>
					</body>
				</loop>
			</body>
		</loop>
	</csv>
</config>